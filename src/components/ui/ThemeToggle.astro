---
// ThemeToggle component for Tailwind v4
---

<div class="relative">
  <button
    id="theme-toggle"
    class="group relative w-14 h-7 sm:w-16 sm:h-8 bg-gray-300 dark:bg-gray-600 rounded-full shadow-inner border-2 border-gray-400 dark:border-gray-500 transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 touch-manipulation"
    aria-label="Switch theme"
    role="switch"
    aria-checked="false"
  >
    <!-- Switch Track -->
    <div class="absolute inset-0 rounded-full bg-gradient-to-r from-gray-200 to-gray-300 dark:from-gray-700 dark:to-gray-600"></div>
    
    <!-- Switch Knob -->
    <div class="absolute top-0.5 left-0.5 w-5 h-5 sm:w-6 sm:h-6 bg-white dark:bg-gray-200 rounded-full shadow-lg transition-all duration-150 transform dark:translate-x-7 sm:dark:translate-x-8 flex items-center justify-center">
      <i class="fas fa-sun text-yellow-500 text-xs sm:text-sm opacity-100 dark:opacity-0 transition-all duration-150"></i>
      <i class="fas fa-moon text-gray-700 text-xs sm:text-sm absolute opacity-0 dark:opacity-100 transition-all duration-150"></i>
    </div>
    
    <!-- Switch Labels -->
    <div class="absolute inset-0 flex items-center justify-between px-1.5 sm:px-2 pointer-events-none">
      <span class="text-xs sm:text-sm font-medium text-gray-600 dark:text-gray-400 opacity-100 dark:opacity-50 transition-opacity duration-150">☀</span>
      <span class="text-xs sm:text-sm font-medium text-gray-400 dark:text-gray-300 opacity-50 dark:opacity-100 transition-opacity duration-150">☽</span>
    </div>
  </button>
</div>

<script>
  
  class ThemeToggle {
    button!: HTMLElement | null;
    currentTheme!: 'light' | 'dark';
    
    constructor() {
      this.button = document.getElementById('theme-toggle');
      this.currentTheme = this.getInitialTheme();
      
      this.init();
    }
    
    getInitialTheme(): 'light' | 'dark' {
      return (window as any).__initialTheme || document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }
    
    init(): void {
      if (!this.button) {
        console.error('Theme toggle button not found');
        return;
      }
      
      this.updateButtonState();
      
      // Add both click and touch events for better mobile support
      this.button.addEventListener('click', (e: Event) => {
        e.preventDefault();
        this.toggleTheme();
      });
      
      this.button.addEventListener('touchstart', (e: Event) => {
        e.preventDefault();
        this.toggleTheme();
      });
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!localStorage.getItem('theme')) {
          this.setTheme(e.matches ? 'dark' : 'light');
        }
      });
    }
    
    toggleTheme(): void {
      const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
      this.setTheme(newTheme);
    }
    
    setTheme(theme: 'light' | 'dark'): void {
      this.currentTheme = theme;
      localStorage.setItem('theme', theme);
      
      // Update DOM immediately
      document.documentElement.classList.remove('dark', 'light');
      document.documentElement.classList.add(theme);
      document.documentElement.setAttribute('data-theme', theme);
      
      this.updateButtonState();
      document.documentElement.offsetHeight; // Force reflow
    }
    
    updateButtonState(): void {
      if (this.button) {
        this.button.setAttribute('aria-label', `Switch to ${this.currentTheme === 'light' ? 'dark' : 'light'} theme`);
        this.button.setAttribute('aria-checked', this.currentTheme === 'dark' ? 'true' : 'false');
      }
    }
  }
  
  // Initialize with better mobile support
  function initializeThemeToggle() {
    // Wait a bit to ensure DOM is fully ready
    setTimeout(() => {
      new ThemeToggle();
    }, 100);
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeThemeToggle);
  } else {
    initializeThemeToggle();
  }
</script>
